<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gest√£o do Restaurante</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- √çcones -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        /* --- SISTEMA DE CORES --- */
        :root { 
            --primary: #D32F2F; 
            --secondary: #2e7d32; 
            --bg: #f8f9fa; 
            --text: #333; 
            --text-light: #666;
            --card-bg: white; 
            --sidebar-bg: white;
            --border: #e0e0e0; 
            --input-bg: white;
            --shadow: 0 2px 10px rgba(0,0,0,0.05);
            --nav-hover: rgba(0,0,0,0.05);
            --danger: #ef5350;
        }
        
        body.dark-mode {
            --primary: #ff5252; 
            --secondary: #66bb6a; 
            --bg: #121212; 
            --text: #e0e0e0; 
            --text-light: #aaa;
            --card-bg: #1e1e1e; 
            --sidebar-bg: #181818;
            --border: #333; 
            --input-bg: #2c2c2c;
            --shadow: 0 4px 10px rgba(0,0,0,0.3);
            --nav-hover: rgba(255,255,255,0.1);
        }

        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }
        
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 0;
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
            width: 100%;
        }

        /* --- SIDEBAR (Desktop) --- */
        aside { 
            width: 260px; 
            background: var(--sidebar-bg); 
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
            flex-shrink: 0; 
            overflow-y: auto;
            z-index: 100;
        }
        
        .brand { 
            font-size: 1.4rem; 
            font-weight: 900; 
            color: var(--primary); 
            margin-bottom: 20px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        /* Container dos links para flexibilidade no mobile */
        .nav-links-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 100%;
            flex: 1;
        }

        .menu-label { 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            color: var(--text-light); 
            margin: 15px 0 5px 0; 
            font-weight: bold; 
            letter-spacing: 1px; 
        }
        
        .menu-item { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 12px; 
            border-radius: 8px; 
            color: var(--text-light); 
            text-decoration: none; 
            transition: 0.2s; 
            font-weight: 500; 
            cursor: pointer; 
            margin-bottom: 5px;
        }
        .menu-item:hover { background: var(--nav-hover); color: var(--primary); }
        .menu-item.active { background: rgba(211, 47, 47, 0.1); color: var(--primary); font-weight: 700; }
        
        .user-info { margin-top: auto; border-top: 1px solid var(--border); padding-top: 20px; }
        .user-email { font-size: 0.8rem; color: var(--text-light); margin-bottom: 10px; word-break: break-all; }

        /* --- √ÅREA PRINCIPAL --- */
        main { 
            flex: 1; 
            overflow-y: auto; 
            padding: 30px; 
            width: 100%; 
            position: relative;
            -webkit-overflow-scrolling: touch; 
        }

        header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; }
        h1 { margin: 0; font-size: 1.8rem; color: var(--text); line-height: 1.2; }
        .restaurant-name { font-size: 1rem; color: var(--text-light); margin-top: 5px; }

        .header-actions { display: flex; gap: 10px; align-items: center; }

        .icon-btn { 
            background: transparent; 
            border: 1px solid var(--border); 
            color: var(--text); 
            width: 40px; height: 40px; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; 
            transition: 0.2s;
        }
        .icon-btn:hover { background: var(--nav-hover); }
        
        .mobile-logout { display: none; color: var(--danger); border-color: var(--danger); }
        .mobile-user-info { display: none; font-size: 0.8rem; color: var(--text-light); margin-bottom: 20px; padding: 8px 12px; background: var(--nav-hover); border-radius: 6px; border: 1px solid var(--border); text-align: center; word-break: break-all; }

        /* Toggle Switch Estilo iOS */
        .switch-container { display: flex; align-items: center; gap: 10px; margin-right: 15px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--secondary); }
        input:checked + .slider:before { transform: translateX(24px); }
        .status-label { font-weight: bold; font-size: 0.9rem; min-width: 60px; text-align: center;}
        .status-closed { color: var(--danger); }
        .status-open { color: var(--secondary); }

        /* --- VIEWS (Abas) --- */
        .view-container { display: none; max-width: 1200px; margin: 0 auto; padding-bottom: 80px; width: 100%; } 
        .view-container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- DASHBOARD --- */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .kpi-label { font-size: 0.9rem; color: var(--text-light); text-transform: uppercase; margin-bottom: 5px; font-weight: 600; }
        .kpi-value { font-size: 1.8rem; font-weight: 800; color: var(--text); }
        
        .chart-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); height: 350px; position: relative; }

        .filter-bar { display: flex; justify-content: flex-end; margin-bottom: 20px; }
        select { padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); }

        /* --- GERENCIAMENTO --- */
        .manage-grid { display: grid; grid-template-columns: 300px 1fr; gap: 25px; }
        
        .section-card { 
            background: var(--card-bg); 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: var(--shadow); 
            border: 1px solid var(--border); 
            margin-bottom: 20px; 
            width: 100%;
            max-width: 100%; 
            box-sizing: border-box;
            /* CORRE√á√ÉO PARA MOBILE: Permite que o card encolha se necess√°rio */
            min-width: 0;
        }
        h2 { margin-top: 0; border-bottom: 2px solid var(--primary); padding-bottom: 10px; font-size: 1.2rem; color: var(--primary); margin-bottom: 20px; }

        .form-group { margin-bottom: 15px; width: 100%; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; color: var(--text-light); }
        
        input, select { 
            width: 100%; 
            max-width: 100%;
            padding: 10px; 
            border: 1px solid var(--border); 
            border-radius: 6px; 
            background: var(--input-bg); 
            color: var(--text); 
            font-size: 1rem; 
            box-sizing: border-box; 
        }
        input:focus { outline: none; border-color: var(--primary); }

        button { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1rem; }
        .btn-primary { background: var(--secondary); color: white; width: 100%; }
        .btn-primary:hover { background: #1b5e20; }
        .btn-add { background: var(--primary); color: white; margin-bottom: 15px; width: 100%; display: flex; align-items: center; justify-content: center; gap: 5px;}
        
        /* Tabela (FIX PARA ROLAGEM APENAS DENTRO DA TABELA) */
        .table-container { 
            width: 100%;
            /* Importante: max-width 100% do pai, n√£o da tela */
            max-width: 100%; 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            background: var(--card-bg);
            display: block; 
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 600px; /* For√ßa a largura para ativar o scroll horizontal */
        }
        
        th { 
            background: rgba(0,0,0,0.03); 
            text-align: left; 
            padding: 12px; 
            font-size: 0.85rem; 
            color: var(--text-light); 
            text-transform: uppercase; 
            white-space: nowrap; 
        }
        
        td { 
            padding: 12px; 
            border-top: 1px solid var(--border); 
            color: var(--text); 
            font-size: 0.95rem; 
            vertical-align: middle;
            white-space: nowrap; 
        }
        
        .action-btns { display: flex; gap: 5px; justify-content: flex-end; }
        .btn-icon { padding: 6px; background: transparent; border: 1px solid var(--border); color: var(--text-light); width: auto; border-radius: 4px; }
        .btn-icon:hover { background: rgba(0,0,0,0.05); color: var(--primary); }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); padding: 20px; box-sizing: border-box; }
        .modal-overlay.open { display: flex; }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 15px; width: 100%; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); border: 1px solid var(--border); max-height: 90vh; overflow-y: auto; }

        /* Mobile */
        @media (max-width: 900px) {
            body { flex-direction: column; overflow-y: auto; }
            
            aside { 
                width: 100%; height: 65px; position: fixed; bottom: 0; left: 0; 
                border-right: none; border-top: 1px solid var(--border); padding: 0; 
                flex-direction: row; justify-content: center; background: var(--sidebar-bg); 
                overflow: visible; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 999;
            }
            
            .nav-links-container { flex-direction: row; justify-content: space-around; align-items: center; width: 100%; gap: 0; }
            .menu-item { flex-direction: column; gap: 2px; padding: 8px 0; font-size: 0.7rem; border-radius: 0; flex: 1; justify-content: center; margin-bottom: 0; height: 100%; }
            .menu-item .material-icons-round { font-size: 1.6rem; }
            .menu-item span:not(.material-icons-round) { display: block; } 

            .brand, .menu-label, .user-info { display: none; }
            .mobile-logout { display: flex; }
            .mobile-user-info { display: block; }

            main { 
                padding: 15px; 
                padding-bottom: 100px; 
                width: 100%;
                max-width: 100vw; /* Garante limite da viewport */
                overflow-x: hidden; /* Esconde o que vazar do main */
            }
            
            /* Grid de 1 coluna */
            .manage-grid, .chart-grid { grid-template-columns: 1fr !important; }
            
            .chart-card { height: 300px; }
            header { margin-bottom: 20px; }
            h1 { font-size: 1.5rem; }
            
            /* Ajuste dos cards no mobile */
            .section-card { 
                padding: 20px; 
                width: 100%; 
                min-width: 0; /* Permite encolher se necess√°rio */
            }
            
            .modal-content { width: 100%; margin: 0; }
            .form-group input, .form-group select { width: 100%; min-width: 0; }
        }
    </style>
</head>
<body>

    <aside>
        <div class="brand">
            <span class="material-icons-round">admin_panel_settings</span> Painel Admin
        </div>

        <div class="nav-links-container">
            <div class="menu-label">Gest√£o</div>
            
            <a class="menu-item active" onclick="switchTab('management')" id="nav-mgmt">
                <span class="material-icons-round">inventory</span> <span>Card√°pio</span>
            </a>
            <a class="menu-item" onclick="switchTab('team')" id="nav-team">
                <span class="material-icons-round">group</span> <span>Equipe</span>
            </a>
            <a class="menu-item" onclick="switchTab('dashboard')" id="nav-dash">
                <span class="material-icons-round">analytics</span> <span>Dashboard</span>
            </a>

            <div class="menu-label">Acesso R√°pido</div>
            
            <a href="#" target="_blank" class="menu-item" id="link-garcom">
                <span class="material-icons-round">smartphone</span> <span>Gar√ßom</span>
            </a>
            <a href="#" target="_blank" class="menu-item" id="link-cozinha">
                <span class="material-icons-round">kitchen</span> <span>Cozinha</span>
            </a>
            <a href="#" target="_blank" class="menu-item" id="link-caixa">
                <span class="material-icons-round">point_of_sale</span> <span>Caixa</span>
            </a>
        </div>

        <div class="user-info">
            <div class="user-email" id="user-email-display-sidebar">...</div>
            <button onclick="window.logout()" style="background: transparent; border: 1px solid var(--danger); color: var(--danger); width: 100%; padding: 8px; cursor: pointer; border-radius: 6px;">Sair</button>
        </div>
    </aside>

    <main>
        <header>
            <div>
                <h1>Vis√£o Geral</h1>
                <div class="restaurant-name" id="header-restaurant-name">...</div>
            </div>
            
            <div class="header-actions">
                <div class="switch-container">
                    <span id="status-text" class="status-label status-closed">FECHADO</span>
                    <label class="switch">
                        <input type="checkbox" id="toggle-operation">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <button class="icon-btn" onclick="toggleTheme()" title="Mudar Tema">
                    <span class="material-icons-round" id="theme-icon">dark_mode</span>
                </button>
                <button class="icon-btn mobile-logout" onclick="window.logout()" title="Sair">
                    <span class="material-icons-round">logout</span>
                </button>
            </div>
        </header>

        <div class="mobile-user-info">
            Logado como: <strong id="user-email-display-mobile">...</strong>
        </div>

        <!-- === VIEW 1: GERENCIAMENTO === -->
        <div id="view-management" class="view-container active">
            <div class="manage-grid">
                <div>
                    <div class="section-card">
                        <h2>‚öôÔ∏è Taxa de Servi√ßo</h2>
                        <div class="form-group">
                            <label>Porcentagem (%)</label>
                            <input type="number" id="input-service-fee" placeholder="0" min="0" max="100">
                        </div>
                        <button class="btn-primary" id="btn-save-configs">Salvar Taxa</button>
                    </div>

                    <div class="section-card">
                        <h2>üè∑Ô∏è Categorias</h2>
                        <form id="category-form" style="display: flex; gap: 5px; margin-bottom: 15px;">
                            <input type="text" id="cat-name" placeholder="Nova Categoria" required>
                            <button type="submit" class="btn-primary" style="width: auto;">+</button>
                        </form>
                        <div id="category-list"></div>
                    </div>
                </div>

                <div class="section-card">
                    <h2>üçî Card√°pio</h2>
                    <!-- BARRA DE BUSCA -->
                    <div style="margin-bottom: 20px;">
                        <input type="text" id="menu-search" placeholder="Buscar item..." oninput="window.filterMenu()" style="width: 100%;">
                    </div>

                    <button class="btn-add" onclick="openProductModal()">
                        <span class="material-icons-round">add</span> Novo Produto
                    </button>
                    
                    <!-- TABELA COM SCROLL -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Pre√ßo</th>
                                    <th>Categoria</th>
                                    <th>Status</th>
                                    <th style="text-align: right;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="products-tbody">
                                <tr><td colspan="5" style="text-align:center; padding: 20px; color: var(--text-light);">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- === VIEW 2: EQUIPE === -->
        <div id="view-team" class="view-container">
            <div class="manage-grid">
                <div>
                    <div class="section-card">
                        <h2>Novo Funcion√°rio</h2>
                        <form id="create-employee-form">
                            <div class="form-group">
                                <label>Nome</label>
                                <input type="text" id="emp-name" placeholder="Ex: Jo√£o" required>
                            </div>
                            <div class="form-group">
                                <label>E-mail de Acesso</label>
                                <input type="email" id="emp-email" placeholder="email@exemplo.com" required>
                            </div>
                            <div class="form-group">
                                <label>Senha</label>
                                <input type="text" id="emp-pass" placeholder="Min 6 caracteres" required minlength="6">
                            </div>
                            <button type="submit" class="btn-primary">Cadastrar</button>
                        </form>
                    </div>
                </div>

                <div class="section-card">
                    <h2>Lista de Funcion√°rios</h2>
                    <!-- TABELA COM SCROLL -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>E-mail</th>
                                    <th style="text-align: right;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="employees-tbody">
                                <tr><td colspan="3" style="text-align:center; padding:20px; color:var(--text-light);">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- === VIEW 3: DASHBOARD === -->
        <div id="view-dashboard" class="view-container">
            <div class="filter-bar">
                <select id="dashboard-period" onchange="loadDashboard()">
                    <option value="30">√öltimos 30 Dias</option>
                    <option value="current_month">M√™s Atual</option>
                    <option value="last_month">M√™s Passado</option>
                </select>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <span class="kpi-label">Faturamento</span>
                    <span class="kpi-value" id="kpi-revenue">R$ 0,00</span>
                </div>
                <div class="kpi-card">
                    <span class="kpi-label">Pedidos</span>
                    <span class="kpi-value" id="kpi-orders">0</span>
                </div>
                <div class="kpi-card">
                    <span class="kpi-label">Ticket M√©dio</span>
                    <span class="kpi-value" id="kpi-ticket">R$ 0,00</span>
                </div>
                <div class="kpi-card">
                    <span class="kpi-label">Top 3 Mais Pedidos</span>
                    <div id="top-products-list" style="font-size: 0.85rem; color: var(--text-light); margin-top: 10px; min-height: 60px;">
                        <span style="opacity: 0.5;">Carregando...</span>
                    </div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-card"><canvas id="salesChart"></canvas></div>
                <div class="chart-card"><canvas id="categoryChart"></canvas></div>
            </div>
        </div>

    </main>

    <!-- MODAL PRODUTO -->
    <div class="modal-overlay" id="product-modal">
        <div class="modal-content">
            <h2 style="margin-top: 0; color: var(--primary); margin-bottom: 20px;">Produto</h2>
            <form id="product-form">
                <input type="hidden" id="product-id" name="id">
                <div class="form-group">
                    <label>Nome do Produto</label>
                    <input type="text" id="prod-name" required>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Pre√ßo (R$)</label>
                        <input type="number" id="prod-price" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Categoria</label>
                        <select id="prod-category" required>
                            <option value="" disabled selected>Selecione</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="prod-available">
                        <option value="true">Ativo (Dispon√≠vel)</option>
                        <option value="false">Pausado (Indispon√≠vel)</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="submit" class="btn-primary">Salvar</button>
                    <button type="button" style="width: 100%; background: transparent; border: 1px solid var(--border); color: var(--text);" onclick="closeProductModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { SaasService } from './js/SaasService.js';
        
        const api = new SaasService(); 

        let restaurantConfigDocId = null;
        let cachedProducts = [];
        let salesListenerUnsubscribe = null;

        // --- 1. AUTENTICA√á√ÉO E INICIO ---
        api.requireAuth((user, role) => {
            if (role !== 'owner' && role !== 'super_admin') {
                alert("Acesso restrito aos donos. Redirecionando para o App.");
                window.location.href = 'garcom.html';
                return;
            }
            document.getElementById('user-email-display-sidebar').innerText = user.email;
            document.getElementById('user-email-display-mobile').innerText = user.email;
            
            const query = `?id=${api.restaurantId}`;
            document.getElementById('link-garcom').href = `garcom.html${query}`;
            document.getElementById('link-cozinha').href = `cozinha.html${query}`;
            document.getElementById('link-caixa').href = `caixa.html${query}`;

            initSystem();
        });

        window.logout = () => api.logout();

        // --- 2. TEMA ---
        window.toggleTheme = () => {
            const body = document.body;
            const icon = document.getElementById('theme-icon');
            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                icon.innerText = 'dark_mode';
                localStorage.setItem('client_theme', 'light');
                updateChartTheme(false);
            } else {
                body.classList.add('dark-mode');
                icon.innerText = 'light_mode';
                localStorage.setItem('client_theme', 'dark');
                updateChartTheme(true);
            }
        };
        if (localStorage.getItem('client_theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-icon').innerText = 'light_mode';
        }

        // --- 3. NAVEGA√á√ÉO ---
        window.switchTab = (tabName) => {
            document.getElementById('nav-dash').classList.remove('active');
            document.getElementById('nav-mgmt').classList.remove('active');
            document.getElementById('nav-team').classList.remove('active');
            
            document.getElementById('view-dashboard').classList.remove('active');
            document.getElementById('view-management').classList.remove('active');
            document.getElementById('view-team').classList.remove('active');

            if (tabName === 'dashboard') {
                document.getElementById('nav-dash').classList.add('active');
                document.getElementById('view-dashboard').classList.add('active');
                loadDashboard();
            } else if (tabName === 'management') {
                document.getElementById('nav-mgmt').classList.add('active');
                document.getElementById('view-management').classList.add('active');
            } else if (tabName === 'team') {
                document.getElementById('nav-team').classList.add('active');
                document.getElementById('view-team').classList.add('active');
                loadEmployees();
            }
        };

        async function initSystem() {
            const config = await api.getRestaurantConfig();
            restaurantConfigDocId = config.docId;
            document.getElementById('header-restaurant-name').innerText = config.restaurantName;
            document.getElementById('input-service-fee').value = config.serviceFeePercentage;
            
            loadCategories();
            loadProducts();
            // Dashboard n√£o carrega automaticamente

            

            // --- L√ìGICA DO BOT√ÉO ABRIR/FECHAR ---
            const toggleBtn = document.getElementById('toggle-operation');
            const statusText = document.getElementById('status-text');
            toggleBtn.checked = config.isOpen;
            updateStatusLabel(config.isOpen);

            // 1. Escutar mudan√ßas vindas do banco (tempo real)
            // O SaasService dispara esse evento quando l√™ o documento
            window.addEventListener('restaurantStatusChanged', (e) => {
                const isOpen = e.detail.isOpen;
                // S√≥ atualiza se for diferente para evitar loop visual
                if (toggleBtn.checked !== isOpen) {
                    toggleBtn.checked = isOpen;
                    updateStatusLabel(isOpen);
                }
            });

            // 2. A√ß√£o de Clicar (Enviar para o banco)
            toggleBtn.addEventListener('change', async (e) => {
                const newState = e.target.checked;
                updateStatusLabel(newState); // Muda visualmente na hora
                
                try {
                    console.log("Salvando status:", newState); // Debug
                    await api.toggleOperationStatus(newState);
                } catch (err) {
                    alert("Erro ao atualizar status: " + err.message);
                    // Reverte se der erro
                    toggleBtn.checked = !newState; 
                    updateStatusLabel(!newState);
                }
            });

            function updateStatusLabel(isOpen) {
                if (isOpen) {
                    statusText.innerText = "ABERTO";
                    statusText.className = "status-label status-open";
                } else {
                    statusText.innerText = "FECHADO";
                    statusText.className = "status-label status-closed";
                }
            }

            document.getElementById('btn-save-configs').onclick = async () => {
                const fee = parseInt(document.getElementById('input-service-fee').value);
                if (isNaN(fee)) return alert("Valor inv√°lido");
                try { await api.updateServiceFee(restaurantConfigDocId, fee); alert("Taxa atualizada!"); }
                catch(e) { alert(e.message); }
            };
        }

        // --- 4. EQUIPE ---
        async function loadEmployees() {
            const tbody = document.getElementById('employees-tbody');
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:var(--text-light);">Carregando...</td></tr>';
            try {
                const employees = await api.getEmployees();
                tbody.innerHTML = "";
                if (employees.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:var(--text-light);">Nenhum funcion√°rio cadastrado.</td></tr>';
                    return;
                }
                employees.forEach(emp => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${emp.name}</td>
                        <td>${emp.email}</td>
                        <td style="text-align: right;">
                            <button class="btn-icon" style="color:var(--danger);" onclick="deleteEmployee('${emp.uid}')">
                                <span class="material-icons-round">delete</span>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) { console.error(e); }
        }

        document.getElementById('create-employee-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('emp-name').value;
            const email = document.getElementById('emp-email').value;
            const pass = document.getElementById('emp-pass').value;
            const btn = e.target.querySelector('button');
            btn.innerText = "..."; btn.disabled = true;
            try {
                await api.registerEmployee(email, pass, api.restaurantId, name);
                alert("Cadastrado!"); e.target.reset(); loadEmployees();
            } catch (err) { alert("Erro: " + err.message); } 
            finally { btn.innerText = "Cadastrar"; btn.disabled = false; }
        });

        window.deleteEmployee = async (uid) => {
            if(confirm("Remover funcion√°rio?")) {
                try { await api.deleteEmployee(uid); loadEmployees(); } catch(e) { alert(e.message); }
            }
        };

        // --- 5. DASHBOARD ---
        let salesChart = null;
        let catChart = null;

        window.loadDashboard = () => {
            if(salesListenerUnsubscribe) salesListenerUnsubscribe();

            const period = document.getElementById('dashboard-period').value;
            let startDate = new Date();
            
            if (period === '30' || period === '60') startDate.setDate(startDate.getDate() - parseInt(period));
            else if (period === 'current_month') startDate.setDate(1);
            else if (period === 'last_month') { startDate.setMonth(startDate.getMonth() - 1); startDate.setDate(1); }
            startDate.setHours(0,0,0,0); 

            salesListenerUnsubscribe = api.listenToAnalytics(startDate, (dailyData) => {
                
                if (period === 'last_month') {
                    const nextMonth = new Date(startDate); nextMonth.setMonth(nextMonth.getMonth() + 1);
                    const strNext = nextMonth.toISOString().split('T')[0];
                    dailyData = dailyData.filter(d => d.date < strNext);
                }

                let totalRevenue = 0;
                let totalOrders = 0;
                let catTotals = {};
                let prodTotals = {};
                const chartMap = {};

                dailyData.forEach(day => {
                    totalRevenue += day.total_revenue || 0;
                    totalOrders += day.order_count || 0;
                    
                    const [yyyy, mm, dd] = day.date.split('-');
                    const dateLabel = `${dd}/${mm}`;
                    chartMap[dateLabel] = day.total_revenue || 0;

                    // --- TRATAMENTO DE CATEGORIAS (Robustez) ---
                    // Verifica chaves planas tipo "categories.lanche"
                    for (const key in day) {
                        if (key.startsWith('categories.')) {
                            const name = key.split('.')[1].toUpperCase();
                            catTotals[name] = (catTotals[name] || 0) + day[key];
                        }
                    }
                    // Verifica objeto aninhado (caso tenha sido salvo corretamente)
                    if (day.categories && typeof day.categories === 'object') {
                        for (const [k, v] of Object.entries(day.categories)) {
                            const name = k.toUpperCase();
                            catTotals[name] = (catTotals[name] || 0) + v;
                        }
                    }

                    // --- TRATAMENTO DE PRODUTOS ---
                    for (const key in day) {
                        if (key.startsWith('products.')) {
                            const name = key.split('.')[1].replace(/_/g, ' ').toUpperCase();
                            prodTotals[name] = (prodTotals[name] || 0) + day[key];
                        }
                    }
                    if (day.products && typeof day.products === 'object') {
                        for (const [k, v] of Object.entries(day.products)) {
                            const name = k.replace(/_/g, ' ').toUpperCase();
                            prodTotals[name] = (prodTotals[name] || 0) + v;
                        }
                    }
                });

                // ATUALIZA KPIs
                const ticket = totalOrders ? totalRevenue / totalOrders : 0;
                document.getElementById('kpi-revenue').innerText = `R$ ${totalRevenue.toFixed(2)}`;
                document.getElementById('kpi-orders').innerText = totalOrders;
                document.getElementById('kpi-ticket').innerText = `R$ ${ticket.toFixed(2)}`;

                // ATUALIZA TOP 3
                const sortedProds = Object.entries(prodTotals).sort((a,b) => b[1] - a[1]).slice(0, 3);
                const topListEl = document.getElementById('top-products-list');
                
                if (topListEl) {
                    if (sortedProds.length > 0) {
                        topListEl.innerHTML = sortedProds.map((p, i) => {
                            const medals = ['ü•á', 'ü•à', 'ü•â'];
                            return `<div style="margin-bottom: 6px; font-size: 0.9rem;">${medals[i]} <strong>${p[0]}</strong> <span style="float:right; opacity: 0.7;">${p[1]} un</span></div>`;
                        }).join('');
                    } else {
                        topListEl.innerHTML = '<span style="opacity: 0.5;">Sem dados.</span>';
                    }
                }

                renderCharts(chartMap, catTotals);
            });
        };
        
        function renderCharts(dailyDataMap, categoryDataMap) {
            const isDark = document.body.classList.contains('dark-mode');
            const color = isDark ? '#e0e0e0' : '#333';

            const ctx1 = document.getElementById('salesChart').getContext('2d');
            const ctx2 = document.getElementById('categoryChart').getContext('2d');

            if(salesChart) salesChart.destroy();
            if(catChart) catChart.destroy();

            // Gr√°fico de Linha
            salesChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: Object.keys(dailyDataMap),
                    datasets: [{
                        label: 'Vendas (R$)',
                        data: Object.values(dailyDataMap),
                        borderColor: '#2e7d32',
                        backgroundColor: 'rgba(46, 125, 50, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { title: {display:true, text:'Evolu√ß√£o Di√°ria', color: color}, legend: {labels:{color:color}} }, 
                    scales: { x: {ticks:{color:color}}, y: {ticks:{color:color}} } 
                }
            });

            // Gr√°fico de Rosca
            catChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryDataMap),
                    datasets: [{
                        data: Object.values(categoryDataMap),
                        backgroundColor: ['#D32F2F', '#FFC107', '#1976D2', '#388E3C', '#7B1FA2']
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { title: {display:true, text:'Mix de Categorias', color: color}, legend: {labels:{color:color}, position: 'right'} } 
                }
            });
        }
        
        function updateChartTheme(isDark) {
            if(salesChart) { 
                const color = isDark ? '#e0e0e0' : '#333';
                salesChart.options.plugins.title.color = color;
                salesChart.options.plugins.legend.labels.color = color;
                salesChart.options.scales.x.ticks.color = color;
                salesChart.options.scales.y.ticks.color = color;
                salesChart.update(); 
            }
            if(catChart) { 
                const color = isDark ? '#e0e0e0' : '#333';
                catChart.options.plugins.title.color = color;
                catChart.options.plugins.legend.labels.color = color;
                catChart.update(); 
            }
        }

        // --- GERENCIAMENTO DE CARD√ÅPIO ---
        function loadCategories() {
            const list = document.getElementById('category-list');
            const select = document.getElementById('prod-category');
            api.listenToCategories((cats) => {
                list.innerHTML = "";
                select.innerHTML = '<option value="" disabled selected>Selecione</option>';
                if(cats.length === 0) list.innerHTML = '<p style="text-align:center; color:var(--text-light);">Sem categorias</p>';
                cats.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'category-item';
                    div.style.display = 'flex'; div.style.justifyContent = 'space-between'; div.style.padding = '10px'; div.style.borderBottom = '1px solid var(--border)';
                    div.innerHTML = `<span>${c.name.toUpperCase()}</span> <button class="btn-icon" style="border:none; background:none; color:var(--primary); cursor:pointer;" onclick="deleteCategory('${c.id}')"><span class="material-icons-round">delete</span></button>`;
                    list.appendChild(div);
                    const opt = document.createElement('option');
                    opt.value = c.name; opt.innerText = c.name.toUpperCase();
                    select.appendChild(opt);
                });
            });
        }

        document.getElementById('category-form').onsubmit = async (e) => {
            e.preventDefault();
            const val = document.getElementById('cat-name').value;
            if(val) { try { await api.saveCategory(val); document.getElementById('cat-name').value = ""; } catch(err) { alert(err.message); } }
        };
        window.deleteCategory = async (id) => { if(confirm("Excluir categoria?")) await api.deleteCategory(id); };

        function loadProducts() {
            const tbody = document.getElementById('products-tbody');
            api.listenToAllProducts((prods) => {
                cachedProducts = prods;
                renderProductTable(prods);
            });
        }
        
        window.renderProductTable = (prods) => {
            const tbody = document.getElementById('products-tbody');
            tbody.innerHTML = "";
            if(prods.length === 0) { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:var(--text-light);">Nenhum produto.</td></tr>`; return; }
            prods.forEach(p => {
                const tr = document.createElement('tr');
                const statusColor = p.available ? 'var(--secondary)' : 'var(--danger)';
                const statusText = p.available ? 'ATIVO' : 'PAUSADO';
                tr.innerHTML = `<td>${p.name}</td><td>R$ ${p.price.toFixed(2)}</td><td style="text-transform: uppercase;">${p.category || '-'}</td><td><span style="color:${statusColor}; font-weight:bold; font-size:0.8rem;">${statusText}</span></td><td class="action-btns"><button class="btn-icon" onclick="editProduct('${p.id}')"><span class="material-icons-round">edit</span></button><button class="btn-icon" style="color:var(--danger);" onclick="deleteProduct('${p.id}')"><span class="material-icons-round">delete</span></button></td>`;
                tbody.appendChild(tr);
            });
        }
        
        window.filterMenu = () => {
            const term = document.getElementById('menu-search').value.toLowerCase();
            const filtered = cachedProducts.filter(p => p.name.toLowerCase().includes(term) || (p.category && p.category.toLowerCase().includes(term)));
            renderProductTable(filtered);
        };

        window.openProductModal = (prod = null) => {
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = ""; 
            if(prod) {
                document.getElementById('product-id').value = prod.id;
                document.getElementById('prod-name').value = prod.name;
                document.getElementById('prod-price').value = prod.price;
                document.getElementById('prod-category').value = prod.category;
                document.getElementById('prod-available').value = prod.available.toString();
            }
            document.getElementById('product-modal').classList.add('open');
        };
        window.closeProductModal = () => document.getElementById('product-modal').classList.remove('open');
        window.editProduct = (id) => { const p = cachedProducts.find(x => x.id === id); if(p) openProductModal(p); };
        window.deleteProduct = async (id) => { if(confirm("Excluir produto?")) await api.deleteProduct(id); };

        document.getElementById('product-form').onsubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = {
                id: form['product-id'].value,
                name: document.getElementById('prod-name').value,
                price: document.getElementById('prod-price').value,
                category: document.getElementById('prod-category').value,
                available: document.getElementById('prod-available').value
            };
            if(!data.category) return alert("Selecione uma categoria");
            try { await api.saveProduct(data); closeProductModal(); } catch(err) { alert(err.message); }
        };
    </script>
</body>
</html>