<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gar√ßom App</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        /* --- TEMAS (Vari√°veis CSS) --- */
        :root { 
            --primary: #D32F2F; 
            --bg: #F4F4F9; 
            --text: #333; 
            --text-light: #666;
            --card-bg: white; 
            --border: #eee; 
            --header-bg: white; 
            --input-bg: #eee;
            --ticket-bg: white; 
            --ticket-border: #ddd;
            --tab-inactive: #888;
            --cat-header: #444;
        }
        
        body.dark-mode {
            --primary: #ff5252; 
            --bg: #121212; 
            --text: #e0e0e0;
            --text-light: #aaa;
            --card-bg: #1e1e1e; 
            --border: #333; 
            --header-bg: #1e1e1e; 
            --input-bg: #2c2c2c;
            --ticket-bg: #1e1e1e; 
            --ticket-border: #444;
            --tab-inactive: #aaa;
            --cat-header: #ddd;
        }

        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--text); padding-bottom: 90px; }
        
        /* HEADER */
        header { background: var(--header-bg); padding: 15px; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .brand { font-weight: 900; color: var(--primary); font-size: 1.2rem; letter-spacing: -0.5px; display: flex; align-items: center; gap: 5px; }
        
        .theme-toggle { background: transparent; border: 1px solid var(--border); border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; color: var(--text); cursor: pointer; padding: 0; }
        
        .mesa-control { display: flex; align-items: center; gap: 10px; background: var(--input-bg); padding: 5px 15px; border-radius: 20px; border: 1px solid transparent; transition: 0.3s; }
        .mesa-control input { width: 50px; border: none; background: transparent; font-size: 1.1rem; font-weight: bold; text-align: center; outline: none; color: var(--text); }
        .mesa-control span { font-size: 0.9rem; color: var(--text); opacity: 0.7; }

        /* TABS (CORRIGIDO PARA EVITAR COLAGEM) */
        .tabs { 
            display: flex; 
            background: var(--header-bg); 
            padding: 0 10px; 
            border-bottom: 1px solid var(--border); 
            position: sticky; 
            top: 65px; 
            z-index: 9; 
            overflow-x: auto; /* Permite rolar se n√£o couber */
            gap: 5px; /* Espa√ßo entre as abas */
            -webkit-overflow-scrolling: touch; /* Rolagem suave no iOS */
        }
        
        .tab { 
            flex: 0 0 auto; /* N√£o estica nem encolhe, usa o tamanho necess√°rio */
            text-align: center; 
            padding: 10px 15px; 
            cursor: pointer; 
            font-weight: 600; 
            color: var(--tab-inactive); 
            position: relative; 
            font-size: 0.85rem; 
            
            /* Quebra de linha controlada */
            white-space: normal; /* Permite quebrar o texto */
            max-width: 100px; /* Limite para for√ßar a quebra se for muito grande */
            line-height: 1.2; /* Altura da linha menor para texto quebrado */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 50px; /* Altura fixa para alinhar todas as abas */
        }
        
        .tab.active { color: var(--primary); opacity: 1; }
        .tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: var(--primary); }

        .tab-badge { background: #4CAF50; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; margin-left: 5px; vertical-align: middle; display: none; }
        .tab-badge.show { display: inline-block; }

        /* BUSCA */
        .search-container { padding: 15px; background: var(--bg); }
        .search-input { width: 100%; padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); font-size: 1rem; outline: none; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .search-input:focus { border-color: var(--primary); }

        /* CATEGORIAS E GRID */
        .menu-content { padding: 0 15px 15px 15px; }
        .category-header { font-size: 1.1rem; font-weight: 800; color: var(--cat-header); margin: 20px 0 10px 0; text-transform: uppercase; letter-spacing: 0.5px; border-left: 4px solid var(--primary); padding-left: 10px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
        
        .card { 
            background: var(--card-bg); border-radius: 10px; overflow: hidden; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.1s; cursor: pointer; 
            display: flex; flex-direction: column; justify-content: space-between;
            border: 1px solid var(--border); 
            padding: 15px;
            min-height: 100px;
        }
        .card:active { transform: scale(0.97); background: var(--input-bg); }
        
        .card-title { font-weight: 700; font-size: 1rem; margin-bottom: 5px; color: var(--text); line-height: 1.2; }
        .card-cat { font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; margin-bottom: 8px; }
        .card-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
        .card-price { color: var(--primary); font-weight: 800; font-size: 1.1rem; }
        .btn-add-mini { background: var(--primary); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; border: none; }

        /* LISTAS (PEDIDOS) */
        .view-section { display: none; }
        .sent-orders-list { padding: 15px; }
        
        .order-ticket { background: var(--ticket-bg); border-radius: 10px; padding: 15px; margin-bottom: 15px; border-left: 5px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid var(--ticket-border); border-left-width: 5px; }
        .order-ticket.st-pending { border-left-color: #FFC107; }
        .order-ticket.st-preparing { border-left-color: #2196F3; }
        .order-ticket.st-ready { border-left-color: #4CAF50; }
        .order-ticket.st-served { border-left-color: #9E9E9E; opacity: 0.7; }
        
        .ticket-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; color: var(--text); opacity: 0.8; align-items: center; }
        .ticket-status { font-weight: bold; text-transform: uppercase; font-size: 0.75rem; padding: 4px 8px; background: var(--input-bg); border-radius: 4px; color: var(--text); }
        .st-ready .ticket-status { background: #4CAF50; color: white; }

        .ticket-item { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.95rem; color: var(--text); }
        .item-obs { font-size: 0.8rem; color: var(--text); opacity: 0.6; font-style: italic; display: block; margin-top: -3px; margin-bottom: 5px; }
        .btn-edit-order { width: 100%; margin-top: 10px; padding: 10px; border: 1px solid var(--primary); color: var(--primary); background: transparent; border-radius: 6px; font-weight: bold; cursor: pointer; }
        
        .btn-mark-served { width: 100%; margin-top: 15px; padding: 12px; background: #2E7D32; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-mark-served:active { transform: scale(0.98); }

        /* MODAIS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: flex-end; }
        .modal-overlay.open { display: flex; }
        .modal-content { background: var(--card-bg); width: 100%; border-radius: 20px 20px 0 0; padding: 25px; animation: slideUp 0.3s; max-height: 80vh; overflow-y: auto; color: var(--text); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .qty-control { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 20px 0; }
        .btn-qty { width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border); background: var(--card-bg); font-size: 1.2rem; color: var(--text); }
        .qty-display { font-size: 1.5rem; font-weight: bold; color: var(--text); }
        textarea.obs-input { width: 100%; border: 1px solid var(--border); border-radius: 8px; padding: 10px; font-family: inherit; margin-bottom: 20px; resize: none; background: var(--input-bg); color: var(--text); }
        
        .cart-item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); color: var(--text); }
        .cart-item-info { flex: 1; }
        .btn-remove { color: #D32F2F; background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px 10px; }
        .btn-edit-note { color: #2196F3; background: none; border: none; font-size: 1rem; cursor: pointer; padding: 0 5px; }
        
        .btn-primary { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .btn-secondary { width: 100%; margin-top: 5px; background: var(--input-bg); border: none; color: var(--text); padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        
        /* BOTTOM BAR */
        .cart-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card-bg); box-shadow: 0 -4px 20px rgba(0,0,0,0.1); padding: 15px; z-index: 50; display: flex; justify-content: space-between; align-items: center; transform: translateY(100%); transition: 0.3s; border-top: 1px solid var(--border); }
        .cart-bar.visible { transform: translateY(0); }
        .cart-summary { display: flex; flex-direction: column; }
        .cart-total { font-size: 1.1rem; font-weight: 900; color: var(--text); }
        .editing-mode-bar { background: #FF9800 !important; }
        .editing-text { color: #d32f2f; font-weight: bold; display: none; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }
        
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text); opacity: 0.6; }
        .empty-icon { font-size: 3rem; margin-bottom: 10px; opacity: 0.5; display: block;}
        .empty-cart-warning { background: rgba(239, 68, 68, 0.1); color: #D32F2F; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 15px; display: none; border: 1px solid #ef9a9a; }
        
        /* COMANDA */
        #view-account { padding: 15px; }
        .account-details { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid var(--border); color: var(--text); }
        .account-item-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed var(--border); font-size: 0.95rem; }
        .account-item-qty { font-weight: bold; margin-right: 10px; opacity: 0.8; }
        .account-total-box { margin-top: 20px; padding: 15px; background: rgba(46, 125, 50, 0.1); border-radius: 8px; text-align: right; }
        .account-total-box div { font-size: 1.4rem; font-weight: 900; color: #2E7D32; }
        .account-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; color: var(--primary); }
    </style>
</head>
<body>

    <header>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div class="brand"><span class="material-icons-round">restaurant_menu</span> SaaS</div>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <button class="theme-toggle" onclick="toggleTheme()" title="Alternar Tema">
                <span class="material-icons-round" id="theme-icon">dark_mode</span>
            </button>
            <div class="mesa-control">
                <span>Mesa:</span>
                <input type="number" id="input-mesa" placeholder="___" value="">
            </div>
        </div>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('menu')">Card√°pio</div>
        <div class="tab" onclick="switchTab('orders')">Pedidos Mesa</div>
        <div class="tab" onclick="switchTab('ready')">
            Prontos <span id="ready-badge" class="tab-badge">0</span>
        </div>
        <div class="tab" onclick="switchTab('account')">Comanda</div>
    </div>

    <!-- 1. CARD√ÅPIO -->
    <div id="view-menu" class="view-section" style="display: block;">
        <!-- CAMPO DE BUSCA -->
        <div class="search-container">
            <input type="text" id="menu-search" class="search-input" placeholder="üîç Buscar produto..." oninput="window.filterMenu()">
        </div>
        
        <!-- CONTE√öDO DO MENU (Categorizado) -->
        <div class="menu-content" id="menu-container">
            <div class="empty-state">
                <span class="empty-icon">üî¢</span>
                Digite o n√∫mero da mesa acima para carregar o card√°pio.
            </div>
        </div>
    </div>

    <!-- 2. PEDIDOS DA MESA -->
    <div id="view-orders" class="view-section sent-orders-list">
        <div id="orders-list-container">
            <div class="empty-state">
                <span class="empty-icon">üìã</span>
                Selecione uma mesa para ver os pedidos.
            </div>
        </div>
    </div>

    <!-- 3. PEDIDOS PRONTOS (TODOS) -->
    <div id="view-ready" class="view-section sent-orders-list">
        <div id="ready-orders-container">
            <div class="empty-state">
                <span class="empty-icon">üë®‚Äçüç≥</span>
                Carregando pedidos prontos...
            </div>
        </div>
    </div>
    
    <!-- 4. COMANDA (VISUALIZA√á√ÉO DO CLIENTE) -->
    <div id="view-account" class="view-section sent-orders-list">
        <div id="account-container">
            <div class="empty-state">
                <span class="empty-icon">üßæ</span>
                Selecione uma mesa para gerar a comanda.
            </div>
        </div>
    </div>

    <!-- BARRA INFERIOR -->
    <div id="cart-bar" class="cart-bar">
        <div class="cart-summary">
            <span class="cart-total" id="cart-total">R$ 0,00</span>
            <span class="cart-count" id="cart-count">0 itens</span>
            <small id="edit-label" class="editing-text">‚úèÔ∏è EDITANDO PEDIDO</small>
        </div>
        <button class="btn-primary" style="width: auto; padding: 10px 25px; border-radius: 25px; background: #2E7D32; margin-bottom: 0;" onclick="openCartModal()">
            Ver Carrinho
        </button>
    </div>

    <!-- MODAL 1: PRODUTO -->
    <div class="modal-overlay" id="product-modal">
        <div class="modal-content">
            <h2 id="modal-prod-name">Produto</h2>
            <p id="modal-prod-price" style="color: var(--text); opacity: 0.7;">R$ 0,00</p>
            <div class="qty-control">
                <button class="btn-qty" onclick="changeModalQty(-1)">-</button>
                <span class="qty-display" id="modal-qty">1</span>
                <button class="btn-qty" onclick="changeModalQty(1)">+</button>
            </div>
            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Observa√ß√µes:</label>
            <textarea id="modal-obs" class="obs-input" rows="2" placeholder="Ex: Sem cebola..."></textarea>
            <button class="btn-primary" onclick="confirmAddToCart()">Adicionar</button>
            <button class="btn-secondary" onclick="closeModal('product-modal')">Cancelar</button>
        </div>
    </div>

    <!-- MODAL 2: CARRINHO -->
    <div class="modal-overlay" id="cart-modal">
        <div class="modal-content">
            <h2>üõí Resumo do Pedido</h2>
            
            <div id="empty-warning" class="empty-cart-warning">
                ‚ö†Ô∏è O carrinho est√° vazio.<br>Salvar agora ir√° <u>CANCELAR</u> este pedido.
            </div>

            <div id="cart-items-list"></div>
            
            <div style="margin: 20px 0; font-size: 1.2rem; font-weight: bold; text-align: right; border-top: 1px solid var(--border); padding-top: 10px; color: var(--text);">
                Total: <span id="modal-cart-total">R$ 0,00</span>
            </div>
            
            <button class="btn-primary" id="btn-confirm-send" onclick="sendOrder()">Confirmar Envio</button>
            
            <!-- BOT√ïES DE CONTROLE DA EDI√á√ÉO -->
            <div id="editing-controls" style="display: none;">
                <button class="btn-secondary" onclick="window.discardEditing()">üîô Sair da Edi√ß√£o (Descartar Altera√ß√µes)</button>
                <button id="btn-cancel-order" class="btn-danger" onclick="window.cancelEditingOrder()">üö´ Cancelar Pedido (Excluir)</button>
            </div>
            
            <button id="btn-close-cart" class="btn-secondary" onclick="closeModal('cart-modal')">Voltar / Adicionar Mais</button>
        </div>
    </div>

    <script type="module">
        import { SaasService } from './js/SaasService.js';
        const api = new SaasService();

        // TRAVA DE SEGURAN√áA (GAR√áOM/FUNCION√ÅRIO/DONO)
        api.requireAuth((user, role) => {
            // Gar√ßom, Dono e Employee podem ver
            initSystem();
        }, ['owner', 'employee']);

        // TEMA LOGIC
        window.toggleTheme = () => {
            const body = document.body;
            const icon = document.getElementById('theme-icon');
            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                icon.innerText = 'dark_mode';
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark-mode');
                icon.innerText = 'light_mode';
                localStorage.setItem('theme', 'dark');
            }
        };
        // Carrega tema
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-icon').innerText = 'light_mode';
        }

        let cart = [];
        let currentEditingOrderId = null;
        let tempProduct = null;
        let unsubscribeOrders = null; 
        let unsubscribeReady = null;
        let SERVICE_FEE_PERCENTAGE = 0.10; 
        let cachedMenuProducts = []; // Cache para busca

        const mesaInput = document.getElementById('input-mesa');
        
        function initSystem() {
             (async () => {
                await fetchRestaurantConfig();
                setupReadyListener();
            })();
        }

        async function fetchRestaurantConfig() {
            try {
                const config = await api.getRestaurantConfig();
                SERVICE_FEE_PERCENTAGE = config.serviceFeePercentage / 100;
            } catch (e) { console.error("Erro config:", e); }
        }

        mesaInput.addEventListener('input', (e) => {
            const mesa = e.target.value;
            cart = []; currentEditingOrderId = null; updateCartUI();
            
            if(mesa) {
                loadMenu();
                setupTableListener(mesa);
            } else {
                document.getElementById('menu-container').innerHTML = `<div class="empty-state"><span class="empty-icon">üî¢</span>Digite o n¬∫ da mesa.</div>`;
                document.getElementById('orders-list-container').innerHTML = `<div class="empty-state"><span class="empty-icon">üìã</span>Selecione uma mesa.</div>`;
                document.getElementById('account-container').innerHTML = `<div class="empty-state"><span class="empty-icon">üßæ</span>Selecione uma mesa.</div>`;
                if(unsubscribeOrders) unsubscribeOrders();
            }
        });

        function setupTableListener(mesa) {
            if(!mesa) return;
            if(unsubscribeOrders) unsubscribeOrders();
            document.getElementById('orders-list-container').innerHTML = "<p style='text-align:center; padding:20px; color:var(--text);'>Buscando pedidos...</p>";
            document.getElementById('account-container').innerHTML = "<p style='text-align:center; padding:20px; color:var(--text);'>Gerando comanda...</p>";

            unsubscribeOrders = api.listenToTableOrders(mesa, (orders) => {
                renderSentOrders(orders);
                renderAccountView(orders); 
            });
        }

        function setupReadyListener() {
            unsubscribeReady = api.listenToReadyOrders((orders) => {
                renderReadyOrders(orders);
                const badge = document.getElementById('ready-badge');
                if(orders.length > 0) {
                    badge.innerText = orders.length;
                    badge.classList.add('show');
                } else {
                    badge.classList.remove('show');
                }
            });
        }

        // --- CARREGAMENTO DO MENU (AGORA COM GRUPOS E BUSCA) ---
        function loadMenu() {
            api.getMenu((produtos) => {
                cachedMenuProducts = produtos;
                renderMenu(produtos);
            });
        }

        window.filterMenu = () => {
            const term = document.getElementById('menu-search').value.toLowerCase();
            const filtered = cachedMenuProducts.filter(p => p.name.toLowerCase().includes(term) || (p.category && p.category.toLowerCase().includes(term)));
            renderMenu(filtered);
        };

        function renderMenu(produtos) {
            const container = document.getElementById('menu-container');
            if(!produtos.length) {
               container.innerHTML = "<p style='text-align:center; padding:20px; color:var(--text);'>Nenhum produto cadastrado.</p>";
               return;
            }
            container.innerHTML = "";

            // Agrupar por Categoria
            const grouped = {};
            produtos.forEach(p => {
                const cat = p.category || 'Outros';
                if(!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(p);
            });

            // Ordenar categorias alfabeticamente
            const sortedCats = Object.keys(grouped).sort();

            sortedCats.forEach(catName => {
                // T√≠tulo da Categoria
                const header = document.createElement('div');
                header.className = 'category-header';
                header.innerText = catName;
                container.appendChild(header);

                // Grid da Categoria
                const grid = document.createElement('div');
                grid.className = 'grid';

                grouped[catName].forEach(prod => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.onclick = () => openProductModal(prod);
                    // SEM IMAGEM, apenas texto e pre√ßo
                    card.innerHTML = `
                        <div>
                            <div class="card-cat">${prod.category}</div>
                            <div class="card-title">${prod.name}</div>
                        </div>
                        <div class="card-bottom">
                            <div class="card-price">R$ ${prod.price.toFixed(2)}</div>
                            <button class="btn-add-mini"><span class="material-icons-round">add</span></button>
                        </div>`;
                    grid.appendChild(card);
                });
                container.appendChild(grid);
            });
        }

        window.openProductModal = (prod) => {
            if(!document.getElementById('input-mesa').value) {
                alert("Por favor, digite o n√∫mero da mesa primeiro.");
                document.getElementById('input-mesa').focus();
                return;
            }
            tempProduct = prod;
            document.getElementById('modal-prod-name').innerText = prod.name;
            document.getElementById('modal-prod-price').innerText = `R$ ${prod.price.toFixed(2)}`;
            document.getElementById('modal-qty').innerText = "1";
            document.getElementById('modal-obs').value = "";
            document.getElementById('product-modal').classList.add('open');
        };

        window.changeModalQty = (delta) => {
            let qty = parseInt(document.getElementById('modal-qty').innerText) + delta;
            if (qty < 1) qty = 1;
            document.getElementById('modal-qty').innerText = qty;
        };

        window.confirmAddToCart = () => {
            const qty = parseInt(document.getElementById('modal-qty').innerText);
            const obs = document.getElementById('modal-obs').value;
            cart.push({
                product_id: tempProduct.id, 
                name: tempProduct.name, 
                price: tempProduct.price, 
                category: tempProduct.category,
                qty: qty, 
                notes: obs
            });
            updateCartUI();
            closeModal('product-modal');
            if(document.getElementById('cart-modal').classList.contains('open')) renderCartItems();
        };

        window.openCartModal = () => {
            if(cart.length === 0 && !currentEditingOrderId) return;
            renderCartItems();
            document.getElementById('cart-modal').classList.add('open');
            const btn = document.getElementById('btn-confirm-send');
            const editControls = document.getElementById('editing-controls');
            const btnClose = document.getElementById('btn-close-cart');
            
            if(currentEditingOrderId) {
                btn.innerText = "üíæ Salvar Altera√ß√µes";
                btn.style.background = "#FF9800"; 
                editControls.style.display = "block"; 
                btnClose.style.display = "none"; 
            } else {
                btn.innerText = "‚úÖ Confirmar Envio";
                btn.style.background = "#2E7D32"; 
                editControls.style.display = "none";
                btnClose.style.display = "block";
            }
        };

        function renderCartItems() {
            const container = document.getElementById('cart-items-list');
            const warning = document.getElementById('empty-warning');
            container.innerHTML = "";
            let total = 0;
            if(cart.length === 0 && currentEditingOrderId) warning.style.display = 'block';
            else warning.style.display = 'none';

            cart.forEach((item, index) => {
                total += item.price * item.qty;
                const div = document.createElement('div');
                div.className = 'cart-item-row';
                div.innerHTML = `
                    <div class="cart-item-info">
                        <div style="font-weight:bold;">${item.qty}x ${item.name}</div>
                        <div style="font-size:0.8rem; opacity:0.7; font-style:italic; display: flex; align-items: center;">
                            Obs: <span id="obs-text-${index}">${item.notes || '-'}</span>
                            <button class="btn-edit-note" onclick="window.editItemNote(${index})">‚úèÔ∏è</button>
                        </div>
                        <div style="color:#2E7D32; font-size:0.9rem;">R$ ${(item.price * item.qty).toFixed(2)}</div>
                    </div>
                    <button class="btn-remove" onclick="window.removeFromCart(${index})">üóëÔ∏è</button>`;
                container.appendChild(div);
            });
            document.getElementById('modal-cart-total').innerText = `R$ ${total.toFixed(2)}`;
        }

        window.editItemNote = (index) => {
            const currentNote = cart[index].notes || "";
            const newNote = prompt("Editar observa√ß√£o:", currentNote);
            if (newNote !== null) {
                cart[index].notes = newNote;
                renderCartItems(); 
            }
        };

        window.removeFromCart = (index) => {
            cart.splice(index, 1);
            renderCartItems();
            updateCartUI();
            if(cart.length === 0 && !currentEditingOrderId) closeModal('cart-modal');
        };

        window.sendOrder = async () => {
            const mesa = document.getElementById('input-mesa').value;
            if(!mesa) { alert("Preencha a mesa!"); return; }
            const total = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
            const btn = document.getElementById('btn-confirm-send');
            try {
                btn.innerText = "Processando...";
                btn.disabled = true;
                if (currentEditingOrderId) {
                    if (cart.length === 0) {
                        if(confirm("O carrinho est√° vazio. Isso ir√° CANCELAR o pedido. Confirmar?")) {
                            await api.cancelOrder(currentEditingOrderId);
                            resetAfterSend();
                        }
                    } else {
                        await api.updateOrder(currentEditingOrderId, cart, total);
                        alert("Pedido atualizado!");
                        resetAfterSend();
                    }
                } else {
                    if (cart.length === 0) alert("Adicione itens.");
                    else {
                        await api.createOrder(mesa, cart, total);
                        alert("Pedido enviado!");
                        resetAfterSend();
                    }
                }
            } catch (e) {
                alert("Erro: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = currentEditingOrderId ? "üíæ Salvar Altera√ß√µes" : "‚úÖ Confirmar Envio";
            }
        };

        window.cancelEditingOrder = async () => {
            if(!currentEditingOrderId) return;
            if(confirm("‚ö†Ô∏è Tem certeza que deseja CANCELAR este pedido completamente?")) {
                try {
                    await api.cancelOrder(currentEditingOrderId);
                    alert("Pedido cancelado.");
                    resetAfterSend();
                } catch(e) { alert("Erro: " + e.message); }
            }
        };

        window.discardEditing = () => {
            if(confirm("Sair sem salvar as altera√ß√µes?")) {
                cart = [];
                currentEditingOrderId = null;
                updateCartUI();
                closeModal('cart-modal');
                switchTab('orders'); 
            }
        };

        window.markAsServed = async (orderId) => {
            if(confirm("Confirmar que o pedido foi entregue na mesa?")) {
                try {
                    await api.updateOrderStatus(orderId, 'served');
                } catch(e) { alert("Erro: " + e.message); }
            }
        };

        function resetAfterSend() {
            cart = []; currentEditingOrderId = null; updateCartUI();
            closeModal('cart-modal'); switchTab('orders');
        }

        function updateCartUI() {
            const total = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
            document.getElementById('cart-total').innerText = `R$ ${total.toFixed(2)}`;
            document.getElementById('cart-count').innerText = `${cart.length} itens`;
            const bar = document.getElementById('cart-bar');
            if (cart.length > 0 || currentEditingOrderId) bar.classList.add('visible');
            else bar.classList.remove('visible');
            const editLabel = document.getElementById('edit-label');
            if (currentEditingOrderId) {
                bar.classList.add('editing-mode-bar');
                editLabel.style.display = 'block';
            } else {
                bar.classList.remove('editing-mode-bar');
                editLabel.style.display = 'none';
            }
        }

        window.closeModal = (id) => document.getElementById(id).classList.remove('open');

        function renderSentOrders(orders) {
            const container = document.getElementById('orders-list-container');
            if (orders.length === 0) {
                container.innerHTML = `<div class="empty-state"><span class="empty-icon">üçΩÔ∏è</span>Nenhum pedido aberto.</div>`;
                return;
            }
            let html = "";
            orders.forEach(order => {
                const itemsHtml = order.items.map(i => `<div><div class="ticket-item"><span><b>${i.qty}x</b> ${i.name}</span><span>R$ ${(i.price * i.qty).toFixed(2)}</span></div>${i.notes ? `<span class="item-obs">üìù ${i.notes}</span>` : ''}</div>`).join('');
                
                let stLabel = order.status;
                let stClass = order.status;
                
                if(order.status === 'pending') stLabel = 'Pendente';
                if(order.status === 'preparing') stLabel = 'Em Preparo';
                if(order.status === 'ready') stLabel = 'Pronto';
                if(order.status === 'served') { stLabel = 'Servido'; stClass = 'served'; }

                const canEdit = order.status !== 'paid' && order.status !== 'finalizado';

                html += `
                    <div class="order-ticket st-${stClass}">
                        <div class="ticket-header"><span>#${order.table_number}</span><span class="ticket-status">${stLabel}</span></div>
                        ${itemsHtml}
                        <div style="border-top:1px solid var(--border); margin-top:10px; padding-top:5px; text-align:right; font-weight:bold; color:var(--text);">Total: R$ ${order.total_amount.toFixed(2)}</div>
                        ${canEdit ? `<button class="btn-edit-order" onclick='window.startEditing("${order.id}")'>‚úèÔ∏è Editar / Modificar</button>` : ''}
                    </div>`;
            });
            container.innerHTML = html;
            window.cachedOrders = orders; 
        }

        function renderReadyOrders(orders) {
            const container = document.getElementById('ready-orders-container');
            if (orders.length === 0) {
                container.innerHTML = `<div class="empty-state"><span class="empty-icon">‚úÖ</span>Tudo entregue.</div>`;
                return;
            }
            let html = "";
            orders.forEach(order => {
                const itemsHtml = order.items.map(i => `<div class="ticket-item"><span>${i.qty}x ${i.name}</span></div>`).join('');
                html += `
                    <div class="order-ticket st-ready">
                        <div class="ticket-header">
                            <span style="font-size:1.2rem; color:#2E7D32;">Mesa ${order.table_number}</span>
                            <span class="ticket-status">PRONTO PARA SERVIR</span>
                        </div>
                        ${itemsHtml}
                        <button class="btn-mark-served" onclick="window.markAsServed('${order.id}')">
                            üèÉ Marcar como Servido
                        </button>
                    </div>`;
            });
            container.innerHTML = html;
        }

        function renderAccountView(orders) {
            const container = document.getElementById('account-container');
            const mesa = document.getElementById('input-mesa').value;
            
            if (orders.length === 0) {
                container.innerHTML = `<div class="empty-state"><span class="empty-icon">üçΩÔ∏è</span>Nenhum consumo aberto na Mesa ${mesa}.</div>`;
                return;
            }
            
            const consolidated = {};
            let totalConta = 0;
            
            orders.forEach(order => {
                order.items.forEach(item => {
                    const key = `${item.name}-${item.notes || ''}`; 
                    totalConta += item.price * item.qty;

                    if (!consolidated[key]) {
                        consolidated[key] = {
                            name: item.name, price: item.price, qty: 0, notes: item.notes, orderCount: 0 
                        };
                    }
                    consolidated[key].qty += item.qty;
                    consolidated[key].orderCount++;
                });
            });

            const taxaServicoRaw = totalConta * SERVICE_FEE_PERCENTAGE;
            const totalGeral = totalConta + taxaServicoRaw;
            const feePercentageDisplay = (SERVICE_FEE_PERCENTAGE * 100).toFixed(0);

            let htmlItems = '';
            Object.values(consolidated).forEach(item => {
                const subtotal = item.price * item.qty;
                const obs = item.notes ? `<span style="font-style: italic; opacity: 0.6;">(${item.notes})</span>` : '';

                htmlItems += `
                    <div class="account-item-row">
                        <div style="flex: 1;">
                            <span class="account-item-qty">${item.qty}x</span> ${item.name} ${obs}
                        </div>
                        <div style="font-weight: bold;">R$ ${subtotal.toFixed(2)}</div>
                    </div>
                `;
            });
            
            let taxaHtml = '';
            if (SERVICE_FEE_PERCENTAGE > 0) {
                taxaHtml = `
                    <div style="font-size: 1.2rem; opacity: 0.8; font-weight: normal;">Taxa de Servi√ßo (${feePercentageDisplay}%): R$ ${taxaServicoRaw.toFixed(2)}</div>
                `;
            }

            const html = `
                <div class="account-details">
                    <div class="account-header">Comanda da Mesa ${mesa}</div>
                    <div style="border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 10px;">
                        ${htmlItems}
                    </div>
                    <div class="account-total-box">
                        <div style="font-size: 1rem; opacity: 0.8; font-weight: normal;">Subtotal: R$ ${totalConta.toFixed(2)}</div>
                        ${taxaHtml}
                        <div style="margin-top: 10px;">
                            TOTAL GERAL: R$ ${totalGeral.toFixed(2)}
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        window.startEditing = (orderId) => {
            const order = window.cachedOrders.find(o => o.id === orderId);
            if(!order) return;
            if(!confirm("Editar trar√° os itens para o carrinho. Continuar?")) return;
            cart = JSON.parse(JSON.stringify(order.items));
            currentEditingOrderId = orderId;
            updateCartUI();
            openCartModal();
        };

        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(v => v.style.display = 'none');
            
            const tabs = document.querySelectorAll('.tab');
            const views = [
                document.getElementById('view-menu'), 
                document.getElementById('view-orders'), 
                document.getElementById('view-ready'),
                document.getElementById('view-account') 
            ];

            if(tabName === 'menu') {
                tabs[0].classList.add('active'); views[0].style.display = 'block';
            } else if(tabName === 'orders') {
                tabs[1].classList.add('active'); views[1].style.display = 'block';
            } else if(tabName === 'ready') {
                tabs[2].classList.add('active'); views[2].style.display = 'block';
            } else if(tabName === 'account') {
                tabs[3].classList.add('active'); views[3].style.display = 'block';
            }
        };
    </script>
</body>
</html>